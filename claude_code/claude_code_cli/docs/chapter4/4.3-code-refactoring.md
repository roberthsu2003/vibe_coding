# 4.3 代碼重構 (refactor)

## 簡介

代碼重構是改善現有代碼結構而不改變其外部行為的過程。Claude Code CLI 提供強大的重構功能，能夠智慧地重組代碼、消除重複、提升可讀性，並遵循最佳實踐。

透過 Claude 的協助，原本需要花費數小時甚至數天的重構工作，可以在幾分鐘內完成，而且更安全、更一致。

## 基本用法

### 重構單一檔案

```bash
# 基本重構
claude refactor src/utils/helper.js

# 指定重構目標
claude "重構 user.service.js，提升代碼可讀性"
```

### 重構整個模組

```bash
# 重構整個目錄
claude refactor ./src/components

# 重構並保留測試
claude refactor ./src/api --keep-tests
```

## 常見重構模式

### 1. 提取函數 (Extract Function)

將重複的代碼片段提取成獨立函數。

```bash
claude "將 calculateTotal 中重複的稅金計算邏輯提取成單獨的函數"
```

**重構前：**
```javascript
function calculateTotal(items) {
  let total = 0;
  items.forEach(item => {
    total += item.price * 1.1; // 重複的稅金計算
  });
  return total;
}

function calculateItemPrice(item) {
  return item.price * 1.1; // 重複的稅金計算
}
```

**重構後：**
```javascript
function calculateWithTax(price) {
  return price * 1.1;
}

function calculateTotal(items) {
  return items.reduce((sum, item) =>
    sum + calculateWithTax(item.price), 0);
}

function calculateItemPrice(item) {
  return calculateWithTax(item.price);
}
```

### 2. 提取變數 (Extract Variable)

將複雜表達式提取成具有描述性名稱的變數。

```bash
claude "重構這個條件判斷，使用有意義的變數名稱"
```

**重構前：**
```javascript
if (user.age > 18 && user.country === 'TW' && user.verified) {
  // 處理邏輯
}
```

**重構後：**
```javascript
const isAdult = user.age > 18;
const isTaiwanResident = user.country === 'TW';
const isVerified = user.verified;
const canProceed = isAdult && isTaiwanResident && isVerified;

if (canProceed) {
  // 處理邏輯
}
```

### 3. 內聯函數 (Inline Function)

將過於簡單的函數內聯到調用處。

```bash
claude "將只有一行的簡單函數內聯到調用處"
```

### 4. 重命名 (Rename)

改善變數、函數或類別的命名。

```bash
# 重命名變數
claude "將所有的 temp、tmp 變數改成有意義的名稱"

# 重命名函數
claude "將 getData 重命名為更具體的名稱"
```

### 5. 移動函數 (Move Function)

將函數移到更合適的模組或類別。

```bash
claude "將 validateEmail 移到 validators 模組"
```

### 6. 拆分類別 (Split Class)

將過大的類別拆分成多個職責單一的類別。

```bash
claude "將 UserManager 類別拆分，遵循單一職責原則"
```

**重構前：**
```javascript
class UserManager {
  createUser(data) { /* ... */ }
  deleteUser(id) { /* ... */ }
  sendEmail(user, message) { /* ... */ }
  validateEmail(email) { /* ... */ }
  encryptPassword(password) { /* ... */ }
}
```

**重構後：**
```javascript
class UserRepository {
  createUser(data) { /* ... */ }
  deleteUser(id) { /* ... */ }
}

class EmailService {
  sendEmail(user, message) { /* ... */ }
  validateEmail(email) { /* ... */ }
}

class PasswordService {
  encryptPassword(password) { /* ... */ }
}
```

### 7. 簡化條件判斷

```bash
claude "簡化這些巢狀的 if-else 條件"
```

**重構前：**
```javascript
function getDiscount(user) {
  if (user.isPremium) {
    if (user.orderCount > 10) {
      return 0.2;
    } else {
      return 0.1;
    }
  } else {
    if (user.orderCount > 10) {
      return 0.05;
    } else {
      return 0;
    }
  }
}
```

**重構後：**
```javascript
function getDiscount(user) {
  const discounts = {
    premium: { high: 0.2, low: 0.1 },
    regular: { high: 0.05, low: 0 }
  };

  const tier = user.isPremium ? 'premium' : 'regular';
  const level = user.orderCount > 10 ? 'high' : 'low';

  return discounts[tier][level];
}
```

## 實用範例

### 範例 1：改善代碼結構

```bash
claude "重構 order.service.js，將它分成：
1. 訂單驗證
2. 訂單處理
3. 訂單通知
三個獨立的模組"
```

### 範例 2：消除重複代碼

```bash
claude "找出並消除 components 目錄下的重複代碼"
```

### 範例 3：現代化語法

```bash
# 使用現代 JavaScript 語法
claude "將這個檔案改用 ES6+ 語法，包括：
- 箭頭函數
- 解構賦值
- async/await
- Optional chaining"
```

### 範例 4：設計模式重構

```bash
# 應用設計模式
claude "重構這個代碼，使用策略模式處理不同的支付方式"

# 移除反模式
claude "修改這個單例模式的實作，使其更易於測試"
```

## 重構工作流程

### 1. 重構前準備

```bash
# 確保有測試
claude "檢查 user.service.js 是否有對應的測試檔案"

# 建立備份分支
git checkout -b refactor/improve-user-service
```

### 2. 執行重構

```bash
# 小步重構
claude "重構 user.service.js 的 getUserById 函數"

# 運行測試確保功能不變
npm test
```

### 3. 驗證結果

```bash
# 檢查重構後的代碼品質
claude analyze src/user.service.js

# 確認測試通過
npm test -- --coverage
```

### 4. 提交變更

```bash
git add src/user.service.js
git commit -m "refactor: improve getUserById function structure"
```

## 安全重構技巧

### 1. 一次只做一件事

```bash
# 好的做法：分步重構
claude "第一步：提取重複的驗證邏輯"
npm test
claude "第二步：改善函數命名"
npm test
claude "第三步：簡化條件判斷"
npm test
```

### 2. 保持測試通過

```bash
# 每次重構後都運行測試
claude refactor src/api/user.js && npm test
```

### 3. 使用型別檢查

```bash
# TypeScript 專案
claude refactor src/service.ts && npx tsc --noEmit
```

### 4. Code Review

```bash
# 重構後請團隊成員審查
git push origin refactor/improve-user-service
gh pr create --title "Refactor: Improve user service structure"
```

## 重構檢查清單

在重構前後檢查以下項目：

- [ ] 所有測試都通過
- [ ] 代碼行為沒有改變
- [ ] 沒有引入新的 bug
- [ ] 代碼更易於理解
- [ ] 減少了重複代碼
- [ ] 遵循專案的代碼規範
- [ ] 效能沒有明顯下降
- [ ] 文檔已更新

## 重構指標

使用以下指標衡量重構效果：

| 指標 | 重構前 | 重構後 | 目標 |
|------|--------|--------|------|
| 循環複雜度 | 15 | 8 | < 10 |
| 重複代碼 | 25% | 5% | < 10% |
| 函數長度 | 150 行 | 30 行 | < 50 行 |
| 測試覆蓋率 | 60% | 85% | > 80% |

## 常見問題

### Q: 什麼時候應該重構？
A: 當代碼難以理解、難以修改，或者發現重複代碼時。建議採用「童子軍規則」：讓代碼比你發現時更好。

### Q: 重構會改變功能嗎？
A: 不應該。重構只改變內部結構，不改變外部行為。這就是為什麼需要測試來確保。

### Q: 如何說服團隊進行重構？
A: 強調長期效益：減少 bug、提升開發速度、降低維護成本。可以從小規模開始展示成效。

### Q: 重構需要多久？
A: 取決於代碼規模。建議每次重構控制在 1-2 小時內，避免大規模重構。

## 最佳實踐

### 1. 小步前進

```bash
# 不要一次改太多
claude "只重構這個函數的參數結構"
```

### 2. 保持測試覆蓋

```bash
# 重構前先補充測試
claude "為即將重構的代碼生成測試"
```

### 3. 使用自動化工具

```bash
# 結合格式化工具
claude refactor src/app.js && npm run prettier
```

### 4. 文檔化重構決策

```bash
# 在 commit message 中說明重構原因
git commit -m "refactor: extract tax calculation logic

- Reason: Duplicated tax calculation in multiple places
- Benefit: Easier to maintain and update tax rates
- Impact: No functional changes, all tests pass"
```

## 延伸閱讀

- [4.2 代碼分析](./4.2-code-analysis.md) - 找出需要重構的代碼
- [4.4 測試生成](./4.4-testing.md) - 確保重構安全
- 《重構：改善既有代碼的設計》by Martin Fowler

---

⏳ 內容持續補充中

## 導航

- **上一節**: [4.2 代碼分析](./4.2-code-analysis.md)
- **下一節**: [4.4 測試生成](./4.4-testing.md)
- **返回章節目錄**: [第四章目錄](./README.md)
- **返回首頁**: [教材首頁](../../README.md)
