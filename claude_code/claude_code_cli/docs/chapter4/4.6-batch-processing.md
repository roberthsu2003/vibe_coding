# 4.6 批次處理功能

## 簡介

當你需要對多個檔案執行相同的操作時，手動一個一個處理既耗時又容易出錯。Claude Code CLI 提供強大的批次處理功能，讓你能夠一次性處理大量檔案，大幅提升工作效率。

無論是重構整個代碼庫、批次生成測試、統一代碼風格，還是遷移到新的框架版本，批次處理都能幫你輕鬆完成。

## 基本用法

### 批次處理多個檔案

```bash
# 處理特定目錄下的所有檔案
claude "為 src/components 下的所有 .js 檔案添加 TypeScript 型別定義"

# 使用萬用字元
claude "重構所有 *.service.js 檔案，改用 async/await"
```

### 條件式批次處理

```bash
# 只處理符合條件的檔案
claude "找出所有沒有測試的檔案，並為它們生成測試"

# 根據檔案內容篩選
claude "找出所有使用 var 的檔案，改用 const/let"
```

## 常見批次操作

### 1. 批次重構

```bash
# 統一命名規範
claude "將所有檔案中的 snake_case 變數名改為 camelCase"

# 更新 API 呼叫
claude "將所有使用舊 API 的代碼改用新 API"
```

**範例：批次更新 import 路徑**
```bash
claude "更新所有檔案的 import 路徑：
- 舊的: import { utils } from '../utils'
- 新的: import { utils } from '@/utils'"
```

### 2. 批次添加功能

```bash
# 批次添加錯誤處理
claude "為所有 API 呼叫添加 try-catch 錯誤處理"

# 批次添加日誌
claude "在所有 controller 函數中添加日誌記錄"
```

### 3. 批次格式化

```bash
# 統一代碼風格
claude "將所有檔案格式化為 Airbnb 風格"

# 統一註解格式
claude "將所有函數註解轉換為 JSDoc 格式"
```

### 4. 版本遷移

```bash
# React 版本升級
claude "將所有 React class 元件改為 functional 元件"

# 套件遷移
claude "將所有使用 moment.js 的代碼改用 date-fns"
```

## 實用範例

### 範例 1：大規模代碼庫重構

```bash
# 步驟 1: 分析影響範圍
claude "分析將 jQuery 改為原生 JavaScript 會影響哪些檔案"

# 步驟 2: 建立備份分支
git checkout -b refactor/remove-jquery

# 步驟 3: 批次重構
claude "將所有使用 jQuery 的代碼改為原生 JavaScript"

# 步驟 4: 批次測試
npm test

# 步驟 5: 逐步提交
git add -A
git commit -m "refactor: migrate from jQuery to vanilla JS"
```

### 範例 2：國際化 (i18n) 導入

```bash
claude "批次處理所有元件：
1. 找出所有硬編碼的中文字串
2. 提取到 i18n 檔案
3. 替換為 t() 函數呼叫"
```

### 範例 3：安全性更新

```bash
# 批次修復安全漏洞
claude "掃描所有檔案，找出並修復：
- SQL 注入風險
- XSS 漏洞
- 未驗證的輸入"
```

### 範例 4：效能優化

```bash
claude "批次優化所有 React 元件：
1. 添加 React.memo
2. 使用 useCallback 包裝函數
3. 使用 useMemo 快取計算結果"
```

## 腳本化批次處理

### 建立批次處理腳本

```bash
# batch-refactor.sh
#!/bin/bash

echo "開始批次重構..."

# 重構所有 service 檔案
for file in src/services/*.js; do
  echo "處理 $file"
  claude "重構 $file，使用現代 ES6+ 語法" --auto-confirm
done

echo "執行測試..."
npm test

echo "完成！"
```

### 使用配置檔

```bash
# claude-batch.config.js
module.exports = {
  tasks: [
    {
      name: '添加 TypeScript 型別',
      pattern: 'src/**/*.js',
      prompt: '添加 TypeScript 型別定義'
    },
    {
      name: '生成測試',
      pattern: 'src/**/*.ts',
      prompt: '生成對應的測試檔案'
    }
  ]
};

# 執行批次任務
claude batch --config claude-batch.config.js
```

## 進階技巧

### 1. 並行處理

```bash
# 同時處理多個檔案（加快速度）
claude batch --parallel 4 "為所有元件生成測試"
```

### 2. 逐步處理與驗證

```bash
# 處理一個檔案後暫停，等待確認
claude batch --interactive "重構所有 API 呼叫"
```

### 3. 乾運行 (Dry Run)

```bash
# 預覽將要執行的變更，不實際修改
claude batch --dry-run "更新所有 import 路徑"
```

### 4. 錯誤處理

```bash
# 遇到錯誤時繼續處理其他檔案
claude batch --continue-on-error "批次添加錯誤處理"

# 記錄錯誤日誌
claude batch "重構檔案" 2> errors.log
```

### 5. 進度追蹤

```bash
# 顯示詳細進度
claude batch --verbose "處理所有檔案"

# 輸出處理報告
claude batch "批次重構" --report batch-report.md
```

## 批次處理策略

### 1. 分批次處理

```bash
# 先處理一小部分測試
claude "重構 src/utils 下的 5 個檔案"

# 確認沒問題後再處理全部
claude "重構所有 utils 檔案"
```

### 2. 優先順序排序

```bash
# 先處理核心模組
claude "優先重構 src/core 目錄"

# 再處理其他模組
claude "重構剩餘的模組"
```

### 3. 增量式遷移

```bash
# 允許新舊代碼共存
claude "新增新版本的函數，保留舊版本並標記為 deprecated"

# 逐步遷移
claude "將 deprecated 函數的使用逐步遷移到新版本"
```

## 整合到 CI/CD

### GitHub Actions

```yaml
name: Batch Processing
on:
  workflow_dispatch:
    inputs:
      task:
        description: '批次任務類型'
        required: true
        type: choice
        options:
          - format
          - add-tests
          - update-deps

jobs:
  batch-process:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Run Batch Task
        run: |
          case ${{ inputs.task }} in
            format)
              claude batch "格式化所有檔案"
              ;;
            add-tests)
              claude batch "生成缺失的測試"
              ;;
            update-deps)
              claude batch "更新相依套件"
              ;;
          esac

      - name: Create PR
        run: |
          git checkout -b batch/${{ inputs.task }}
          git add -A
          git commit -m "chore: batch ${{ inputs.task }}"
          gh pr create --title "Batch: ${{ inputs.task }}"
```

### 定期批次任務

```yaml
# .github/workflows/weekly-maintenance.yml
name: Weekly Maintenance
on:
  schedule:
    - cron: '0 0 * * 0'  # 每週日執行

jobs:
  maintenance:
    runs-on: ubuntu-latest
    steps:
      - name: Check Code Quality
        run: claude analyze ./src --report quality-report.md

      - name: Update Documentation
        run: claude batch "更新所有文檔註解"

      - name: Run Tests
        run: npm test
```

## 最佳實踐

### 1. 事前準備

```bash
# 檢查清單
- [ ] 建立備份分支
- [ ] 確保有完整的測試
- [ ] 預估處理時間
- [ ] 通知團隊成員
```

### 2. 小範圍測試

```bash
# 先在單一檔案測試
claude "重構 user.service.js"

# 確認結果正確後再批次處理
claude "用同樣的方式重構所有 service 檔案"
```

### 3. 版本控制

```bash
# 每個批次任務使用獨立分支
git checkout -b batch/add-error-handling

# 提交時說明批次處理的範圍和目的
git commit -m "feat: batch add error handling to all API calls"
```

### 4. 充分測試

```bash
# 批次處理後執行完整測試
npm test -- --coverage

# 手動檢查關鍵功能
npm run e2e
```

### 5. 分階段部署

```bash
# 不要一次全部部署
# 先部署到測試環境
git push origin batch/refactor --force-with-lease

# 觀察一段時間
# 確認沒問題後再部署到生產環境
```

## 批次處理檢查清單

執行大規模批次處理前：

- [ ] 已建立備份分支
- [ ] 已在小範圍測試成功
- [ ] 所有測試都通過
- [ ] 已通知團隊成員
- [ ] 預留充足的處理時間
- [ ] 準備好回滾方案
- [ ] 文檔已更新
- [ ] Code review 已完成

## 常見問題

### Q: 批次處理失敗了怎麼辦？
A: 使用 git 回滾到處理前的狀態，分析失敗原因，修正後再重試。

### Q: 如何確保批次處理的一致性？
A: 使用明確的指令和範例，讓 Claude 理解統一的處理標準。

### Q: 批次處理會影響正在進行的開發嗎？
A: 建議在獨立分支進行，並選擇團隊較不忙碌的時間執行。

### Q: 需要人工檢查每個變更嗎？
A: 關鍵代碼建議人工檢查，但可以使用自動化測試驗證大部分變更。

## 效能考量

| 檔案數量 | 建議策略 |
|---------|---------|
| < 10 個 | 直接批次處理 |
| 10-50 個 | 分批處理，每批 10 個 |
| 50-200 個 | 並行處理，建立詳細日誌 |
| > 200 個 | 考慮分天處理，設定檢查點 |

## 小技巧

1. **使用版本控制**：每個批次任務都應該有對應的 commit
2. **保留日誌**：記錄處理過程，方便追蹤問題
3. **漸進式推進**：不要一次改太多，分階段進行
4. **自動化測試**：批次處理後自動運行測試套件
5. **設定時間限制**：避免單次處理時間過長

## 延伸閱讀

- [4.3 代碼重構](./4.3-code-refactoring.md) - 重構技巧
- [6.5 自動化部署](../chapter6/6.5-automation.md) - 自動化流程
- [7.3 良好使用習慣](../chapter7/7.3-good-habits.md) - 最佳實踐

---

⏳ 內容持續補充中

## 導航

- **上一節**: [4.5 文檔生成](./4.5-documentation.md)
- **下一章**: [第五章：CLI vs VSCode 版差異](../chapter5/README.md)
- **返回章節目錄**: [第四章目錄](./README.md)
- **返回首頁**: [教材首頁](../../README.md)
