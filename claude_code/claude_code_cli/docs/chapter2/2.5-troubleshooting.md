# 2.5 疑難排解

## 安裝與設定常見問題

本節收集了在安裝和設定 Claude Code CLI 時最常遇到的問題和解決方法。

## Node.js 相關問題

### Q: 找不到 node 命令

**錯誤訊息**：
```
'node' is not recognized as an internal or external command
```

**解決方法**：

1. **確認 Node.js 已安裝**：
   - 重新安裝 Node.js
   - 安裝時勾選「Add to PATH」選項

2. **手動添加到 PATH**（Windows）：
   ```powershell
   # 檢查 Node.js 安裝路徑
   where node

   # 如果找不到，手動添加（通常在）
   C:\Program Files\nodejs\
   ```

3. **重新開啟終端機**：
   - 設定 PATH 後必須重新開啟終端機

### Q: Node.js 版本太舊

**錯誤訊息**：
```
Error: Claude CLI requires Node.js 16.0 or higher
```

**解決方法**：

```bash
# 檢查目前版本
node --version

# 更新 Node.js（Windows/macOS）
# 前往 https://nodejs.org/ 下載最新 LTS 版本

# 使用 n 模組更新（macOS/Linux）
sudo npm install -g n
sudo n lts
```

## npm 相關問題

### Q: npm 權限錯誤（macOS/Linux）

**錯誤訊息**：
```
Error: EACCES: permission denied
```

**解決方法**：

```bash
# 方法 1: 設定 npm 全域目錄（推薦）
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
echo 'export PATH=~/.npm-global/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 重新安裝
npm install -g @anthropic-ai/claude-cli
```

```bash
# 方法 2: 使用 sudo（不推薦）
sudo npm install -g @anthropic-ai/claude-cli
```

### Q: npm 安裝速度很慢

**解決方法**：

```bash
# 使用國內鏡像（中國大陸用戶）
npm config set registry https://registry.npmmirror.com
npm install -g @anthropic-ai/claude-cli

# 恢復官方源
npm config set registry https://registry.npmjs.org/
```

## Claude CLI 安裝問題

### Q: 找不到 claude 命令

**錯誤訊息**：
```
claude: command not found
```

**解決方法**：

1. **確認安裝成功**：
   ```bash
   npm list -g @anthropic-ai/claude-cli
   ```

2. **檢查全域安裝路徑**：
   ```bash
   npm config get prefix
   ```

3. **將 npm 全域路徑加入 PATH**：

   **macOS/Linux (Bash)**：
   ```bash
   echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> ~/.bashrc
   source ~/.bashrc
   ```

   **macOS (Zsh)**：
   ```bash
   echo 'export PATH="$(npm config get prefix)/bin:$PATH"' >> ~/.zshrc
   source ~/.zshrc
   ```

### Q: Claude CLI 版本不正確

**解決方法**：

```bash
# 清除 npm 快取
npm cache clean --force

# 解除安裝舊版
npm uninstall -g @anthropic-ai/claude-cli

# 重新安裝最新版
npm install -g @anthropic-ai/claude-cli

# 驗證版本
claude --version
```

## API 金鑰問題

### Q: API 金鑰無效

**錯誤訊息**：
```
Error: Invalid API key
```

**解決方法**：

1. **確認金鑰格式正確**：
   - 應該以 `sk-ant-api03-` 開頭
   - 長度約 100+ 字元

2. **重新設定環境變數**：
   ```bash
   # 清除舊的設定
   unset ANTHROPIC_API_KEY

   # 設定新的金鑰
   export ANTHROPIC_API_KEY="your-correct-key-here"

   # 測試連線
   claude test-connection
   ```

3. **檢查金鑰是否過期**：
   - 前往 [Anthropic Console](https://console.anthropic.com/)
   - 檢查金鑰狀態
   - 必要時重新生成

### Q: 找不到 API 金鑰

**錯誤訊息**：
```
Error: ANTHROPIC_API_KEY environment variable not set
```

**解決方法**：

```bash
# 檢查環境變數
echo $ANTHROPIC_API_KEY  # macOS/Linux
echo %ANTHROPIC_API_KEY%  # Windows CMD
$env:ANTHROPIC_API_KEY    # Windows PowerShell

# 如果沒有輸出，重新設定
export ANTHROPIC_API_KEY="your-api-key"
```

### Q: API 配額已用完

**錯誤訊息**：
```
Error: API rate limit exceeded
```

**解決方法**：
- 等待配額重置（通常每月重置）
- 前往 Anthropic Console 檢查使用量
- 考慮升級訂閱方案

## 連線問題

### Q: 網路連線失敗

**錯誤訊息**：
```
Error: Failed to connect to API
```

**解決方法**：

1. **檢查網路連線**：
   ```bash
   ping api.anthropic.com
   ```

2. **檢查防火牆設定**：
   - 確保允許 Node.js 存取網路
   - 檢查企業防火牆設定

3. **使用代理伺服器**：
   ```bash
   export HTTP_PROXY=http://proxy.example.com:8080
   export HTTPS_PROXY=http://proxy.example.com:8080
   ```

### Q: 執行速度很慢

**可能原因**：
- 網路速度較慢
- API 伺服器負載高

**優化方法**：

```bash
# 啟用快取
claude config set cache-enabled true

# 調整 token 限制
claude config set max-tokens 2048

# 減少並行請求
claude config set parallel-jobs 1
```

## 輸出顯示問題

### Q: 輸出亂碼（中文顯示問題）

**Windows 解決方法**：
```powershell
# 設定編碼為 UTF-8
chcp 65001

# 永久設定（PowerShell）
[Console]::OutputEncoding = [System.Text.Encoding]::UTF8
```

**macOS/Linux 解決方法**：
```bash
# 設定語系
export LANG=zh_TW.UTF-8
export LC_ALL=zh_TW.UTF-8

# 加入設定檔
echo 'export LANG=zh_TW.UTF-8' >> ~/.bashrc
source ~/.bashrc
```

### Q: 顏色顯示異常

**解決方法**：

```bash
# 停用顏色輸出
claude config set color-output false

# 或使用環境變數
export NO_COLOR=1
```

## 配置檔案問題

### Q: 配置檔案損壞

**解決方法**：

```bash
# 備份現有配置
cp ~/.claude/config.json ~/.claude/config.json.backup

# 重置配置
claude config reset

# 重新設定必要項目
claude config set api-key your-api-key
```

### Q: 無法寫入配置檔案

**錯誤訊息**：
```
Error: EACCES: permission denied
```

**解決方法**：

```bash
# 檢查目錄權限
ls -la ~/.claude/

# 修正權限
chmod 755 ~/.claude/
chmod 644 ~/.claude/config.json

# 如果目錄不存在，建立它
mkdir -p ~/.claude/
```

## 取得協助

如果上述方法都無法解決問題：

### 1. 查看官方文檔
- [Claude Code 官方文檔](https://docs.claude.com/en/docs/claude-code)
- [Anthropic API 文檔](https://docs.anthropic.com/)

### 2. 社群支援
- [Stack Overflow - Claude Tag](https://stackoverflow.com/questions/tagged/claude)
- [Anthropic 開發者社群](https://community.anthropic.com/)

### 3. 提供詳細資訊

回報問題時，請提供：
```bash
# 系統資訊
node --version
npm --version
claude --version

# 錯誤訊息（完整的）
claude generate --prompt "test" --verbose

# 設定資訊（移除敏感資訊）
claude config list
```

⏳ **本節內容持續補充中**

---

## 導航

- **上一節**: [2.4 首次使用測試](./2.4-first-test.md)
- **下一章**: [第三章：介面導覽](../chapter3/README.md)
- **返回**: [第二章目錄](./README.md)
