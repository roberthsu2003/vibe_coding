# 6.2 步驟一：建立 Express API

## 簡介

在本節中，我們將使用 Claude Code CLI 建立一個完整的 RESTful API，實作待辦事項（Todo）的 CRUD（建立、讀取、更新、刪除）操作。你將學習如何有效地使用 Claude 來加速 API 開發流程。

## 學習目標

完成本節後，你將能夠：
- ✅ 使用 Claude 快速建立資料模型
- ✅ 實作完整的 CRUD API 端點
- ✅ 添加輸入驗證和錯誤處理
- ✅ 測試 API 功能

## 建立資料模型

### 步驟 1：定義 Todo 模型

```bash
# 使用 Claude 建立 Todo 模型
claude "建立一個 Mongoose Todo 模型，包含：
- title (字串，必填)
- description (字串，選填)
- completed (布林值，預設 false)
- priority (字串，low/medium/high，預設 medium)
- dueDate (日期，選填)
- createdAt (日期，自動)
- updatedAt (日期，自動)
並加上適當的驗證" --output src/models/Todo.js
```

**預期輸出 src/models/Todo.js：**
```javascript
const mongoose = require('mongoose');

const todoSchema = new mongoose.Schema({
  title: {
    type: String,
    required: [true, '標題為必填欄位'],
    trim: true,
    maxlength: [100, '標題不能超過 100 個字元']
  },
  description: {
    type: String,
    trim: true,
    maxlength: [500, '描述不能超過 500 個字元']
  },
  completed: {
    type: Boolean,
    default: false
  },
  priority: {
    type: String,
    enum: {
      values: ['low', 'medium', 'high'],
      message: '{VALUE} 不是有效的優先級'
    },
    default: 'medium'
  },
  dueDate: {
    type: Date
  }
}, {
  timestamps: true // 自動添加 createdAt 和 updatedAt
});

module.exports = mongoose.model('Todo', todoSchema);
```

### 步驟 2：建立資料庫連線工具

```bash
claude "建立資料庫連線模組，包含：
- 連線到 MongoDB
- 錯誤處理
- 連線成功/失敗的日誌" --output src/utils/database.js
```

## 建立 Controllers

### 步驟 3：建立 Todo Controller

```bash
claude "建立 Todo Controller，實作以下功能：
1. getAllTodos - 獲取所有待辦事項，支援：
   - 分頁（page, limit）
   - 篩選（completed, priority）
   - 排序（sortBy, order）
2. getTodoById - 根據 ID 獲取單一待辦事項
3. createTodo - 建立新待辦事項
4. updateTodo - 更新待辦事項
5. deleteTodo - 刪除待辦事項
包含完整的錯誤處理" --output src/controllers/todoController.js
```

**預期輸出重點：**
```javascript
const Todo = require('../models/Todo');

// 獲取所有待辦事項
exports.getAllTodos = async (req, res) => {
  try {
    const {
      page = 1,
      limit = 10,
      completed,
      priority,
      sortBy = 'createdAt',
      order = 'desc'
    } = req.query;

    // 建立篩選條件
    const filter = {};
    if (completed !== undefined) {
      filter.completed = completed === 'true';
    }
    if (priority) {
      filter.priority = priority;
    }

    // 執行查詢
    const todos = await Todo.find(filter)
      .sort({ [sortBy]: order === 'desc' ? -1 : 1 })
      .limit(limit * 1)
      .skip((page - 1) * limit);

    const total = await Todo.countDocuments(filter);

    res.json({
      todos,
      pagination: {
        page: parseInt(page),
        limit: parseInt(limit),
        total,
        pages: Math.ceil(total / limit)
      }
    });
  } catch (error) {
    res.status(500).json({
      message: '獲取待辦事項失敗',
      error: error.message
    });
  }
};

// 建立待辦事項
exports.createTodo = async (req, res) => {
  try {
    const todo = new Todo(req.body);
    await todo.save();

    res.status(201).json({
      message: '待辦事項建立成功',
      todo
    });
  } catch (error) {
    if (error.name === 'ValidationError') {
      return res.status(400).json({
        message: '驗證錯誤',
        errors: Object.values(error.errors).map(e => e.message)
      });
    }

    res.status(500).json({
      message: '建立待辦事項失敗',
      error: error.message
    });
  }
};

// ... 其他方法
```

## 建立 Routes

### 步驟 4：建立路由

```bash
claude "建立 Todo 路由，定義以下端點：
- GET /api/todos - 獲取所有待辦事項
- GET /api/todos/:id - 獲取單一待辦事項
- POST /api/todos - 建立待辦事項
- PUT /api/todos/:id - 更新待辦事項
- DELETE /api/todos/:id - 刪除待辦事項
並連接到對應的 controller 方法" --output src/routes/todoRoutes.js
```

**預期輸出 src/routes/todoRoutes.js：**
```javascript
const express = require('express');
const router = express.Router();
const todoController = require('../controllers/todoController');

// 待辦事項路由
router.get('/', todoController.getAllTodos);
router.get('/:id', todoController.getTodoById);
router.post('/', todoController.createTodo);
router.put('/:id', todoController.updateTodo);
router.delete('/:id', todoController.deleteTodo);

module.exports = router;
```

## 建立中介層

### 步驟 5：建立驗證中介層

```bash
claude "建立輸入驗證中介層，用於驗證：
1. createTodo - 確保 title 必填，其他欄位格式正確
2. updateTodo - 驗證更新的欄位格式
包含詳細的錯誤訊息" --output src/middleware/validation.js
```

### 步驟 6：建立錯誤處理中介層

```bash
claude "建立全域錯誤處理中介層，包含：
- 404 錯誤處理
- 通用錯誤處理
- 開發/生產環境不同的錯誤訊息" --output src/middleware/errorHandler.js
```

## 整合應用程式

### 步驟 7：更新 app.js

```bash
claude "更新 Express 應用程式，整合：
1. 資料庫連線
2. 中介層（cors, json parser, 日誌）
3. Todo 路由（掛載在 /api/todos）
4. 錯誤處理中介層
5. 健康檢查端點" --output src/app.js
```

**預期輸出 src/app.js：**
```javascript
require('dotenv').config();
const express = require('express');
const cors = require('cors');
const connectDatabase = require('./utils/database');
const todoRoutes = require('./routes/todoRoutes');
const errorHandler = require('./middleware/errorHandler');

const app = express();
const PORT = process.env.PORT || 3000;

// 連線資料庫
connectDatabase();

// 中介層
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// 簡單的請求日誌
app.use((req, res, next) => {
  console.log(`${new Date().toISOString()} - ${req.method} ${req.path}`);
  next();
});

// 路由
app.get('/health', (req, res) => {
  res.json({ status: 'ok', timestamp: new Date().toISOString() });
});

app.use('/api/todos', todoRoutes);

// 404 處理
app.use((req, res) => {
  res.status(404).json({ message: '找不到請求的資源' });
});

// 錯誤處理
app.use(errorHandler);

// 啟動伺服器
app.listen(PORT, () => {
  console.log(`🚀 Server is running on port ${PORT}`);
  console.log(`📍 API: http://localhost:${PORT}/api/todos`);
});

module.exports = app;
```

## 測試 API

### 步驟 8：手動測試

```bash
# 啟動伺服器
npm run dev

# 在另一個終端機測試
```

**測試健康檢查：**
```bash
curl http://localhost:3000/health
```

**建立待辦事項：**
```bash
curl -X POST http://localhost:3000/api/todos \
  -H "Content-Type: application/json" \
  -d '{
    "title": "學習 Claude Code CLI",
    "description": "完成實戰練習",
    "priority": "high",
    "dueDate": "2024-12-31"
  }'
```

**獲取所有待辦事項：**
```bash
curl http://localhost:3000/api/todos
```

**獲取單一待辦事項：**
```bash
# 替換 TODO_ID 為實際的 ID
curl http://localhost:3000/api/todos/TODO_ID
```

**更新待辦事項：**
```bash
curl -X PUT http://localhost:3000/api/todos/TODO_ID \
  -H "Content-Type: application/json" \
  -d '{
    "completed": true
  }'
```

**刪除待辦事項：**
```bash
curl -X DELETE http://localhost:3000/api/todos/TODO_ID
```

### 步驟 9：使用 Postman/Insomnia 測試

**建立 Postman Collection：**
```bash
claude "生成 Postman Collection JSON，包含所有 Todo API 端點" --output docs/postman-collection.json
```

## 添加進階功能

### 步驟 10：批次操作

```bash
claude "在 todoController.js 中添加批次操作功能：
1. batchCreate - 批次建立多個待辦事項
2. batchUpdate - 批次更新（例如全部標記為完成）
3. batchDelete - 批次刪除" --output src/controllers/todoController.batch.js
```

### 步驟 11：搜尋功能

```bash
claude "添加搜尋功能到 getAllTodos，支援：
- 標題和描述的文字搜尋
- 日期範圍篩選（dueDate）
- 多條件組合" --modify src/controllers/todoController.js
```

## 代碼優化

### 步驟 12：使用 Claude 分析和優化

```bash
# 分析代碼品質
claude analyze src/controllers/todoController.js

# 優化建議
claude "分析 todoController.js 並提供優化建議，特別是：
- 錯誤處理
- 代碼重複
- 效能優化"
```

### 步驟 13：提取通用邏輯

```bash
claude "提取 controller 中重複的錯誤處理邏輯，建立：
1. asyncHandler - 包裝異步函數
2. validateObjectId - 驗證 MongoDB ObjectId
3. buildQueryFilter - 建立查詢篩選器" --output src/utils/helpers.js
```

## 檢查清單

完成本節後，確認以下項目：

- [ ] Todo 模型已建立並包含適當驗證
- [ ] 所有 CRUD 操作的 Controller 已實作
- [ ] 路由已正確設定
- [ ] 中介層（驗證、錯誤處理）已建立
- [ ] app.js 已整合所有元件
- [ ] 所有 API 端點都能正常運作
- [ ] 錯誤處理正確運作
- [ ] 已手動測試所有端點

## 常見問題

### Q: 資料庫連線失敗怎麼辦？
A: 確認 MongoDB 服務正在運行，檢查 .env 中的 DATABASE_URL 是否正確。

### Q: 驗證錯誤沒有正確顯示？
A: 檢查 createTodo 中的錯誤處理，確保捕獲 ValidationError。

### Q: API 回傳 404？
A: 檢查路由是否正確掛載，確認 URL 路徑正確。

### Q: 如何測試沒有資料庫的情況？
A: 可以暫時使用記憶體陣列代替資料庫，或使用 MongoDB Memory Server。

## 故障排除

### 伺服器無法啟動

```bash
# 檢查 Port 是否被佔用
lsof -i :3000

# 檢查環境變數
cat .env

# 查看詳細錯誤
NODE_ENV=development npm run dev
```

### Mongoose 連線錯誤

```bash
# 確認 MongoDB 正在運行
# macOS (使用 Homebrew)
brew services list | grep mongodb

# 或使用 Docker
docker ps | grep mongo

# 重新啟動 MongoDB
brew services restart mongodb-community
# 或
docker restart mongodb
```

## 下一步

API 基本功能已完成！下一節我們將為這些 API 生成完整的測試。

---

⏳ 內容持續補充中

## 導航

- **上一節**: [6.1 準備工作](./6.1-preparation.md)
- **下一節**: [6.3 生成測試](./6.3-generate-tests.md)
- **返回章節目錄**: [第六章目錄](./README.md)
- **返回首頁**: [教材首頁](../../README.md)
