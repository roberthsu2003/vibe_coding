# 6.3 步驟二：生成測試

## 簡介

測試是確保代碼品質的關鍵。在本節中，我們將使用 Claude Code CLI 為上一節建立的 API 生成完整的測試套件，包括單元測試和整合測試。

## 學習目標

完成本節後，你將能夠：
- ✅ 為 API 端點生成整合測試
- ✅ 為 Controller 生成單元測試
- ✅ 為資料模型生成驗證測試
- ✅ 設定測試環境和資料庫
- ✅ 達到良好的測試覆蓋率

## 測試環境設定

### 步驟 1：安裝測試套件

```bash
# 安裝測試相關套件
npm install --save-dev jest supertest mongodb-memory-server

# 如果使用 MongoDB
npm install --save-dev @shelf/jest-mongodb
```

### 步驟 2：設定測試環境

```bash
claude "建立測試環境設定檔，包含：
1. 測試資料庫配置
2. 測試環境變數
3. 測試前後的設定和清理" --output tests/setup.js
```

**預期輸出 tests/setup.js：**
```javascript
const { MongoMemoryServer } = require('mongodb-memory-server');
const mongoose = require('mongoose');

let mongoServer;

// 測試開始前
beforeAll(async () => {
  // 啟動 MongoDB Memory Server
  mongoServer = await MongoMemoryServer.create();
  const mongoUri = mongoServer.getUri();

  // 連線到測試資料庫
  await mongoose.connect(mongoUri, {
    useNewUrlParser: true,
    useUnifiedTopology: true,
  });
});

// 每個測試後清空資料庫
afterEach(async () => {
  const collections = mongoose.connection.collections;
  for (const key in collections) {
    await collections[key].deleteMany();
  }
});

// 所有測試結束後
afterAll(async () => {
  await mongoose.disconnect();
  await mongoServer.stop();
});
```

### 步驟 3：更新 Jest 配置

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'node',
  coverageDirectory: 'coverage',
  collectCoverageFrom: [
    'src/**/*.js',
    '!src/app.js'
  ],
  testMatch: [
    '**/tests/**/*.test.js'
  ],
  setupFilesAfterEnv: ['<rootDir>/tests/setup.js'],
  testTimeout: 10000
};
```

## 單元測試

### 步驟 4：測試 Todo 模型

```bash
claude "為 Todo 模型生成單元測試，涵蓋：
1. 成功建立有效的 Todo
2. 必填欄位驗證（title）
3. 預設值驗證（completed, priority）
4. 列舉值驗證（priority）
5. 最大長度驗證
6. 時間戳記自動產生" --output tests/unit/models/Todo.test.js
```

**預期輸出範例：**
```javascript
const Todo = require('../../../src/models/Todo');

describe('Todo Model', () => {
  describe('驗證', () => {
    it('應該成功建立有效的 Todo', async () => {
      const validTodo = {
        title: '測試待辦事項',
        description: '這是測試描述',
        priority: 'high'
      };

      const todo = new Todo(validTodo);
      const savedTodo = await todo.save();

      expect(savedTodo._id).toBeDefined();
      expect(savedTodo.title).toBe(validTodo.title);
      expect(savedTodo.description).toBe(validTodo.description);
      expect(savedTodo.completed).toBe(false); // 預設值
      expect(savedTodo.priority).toBe('high');
    });

    it('應該拒絕沒有 title 的 Todo', async () => {
      const invalidTodo = new Todo({
        description: '沒有標題'
      });

      let error;
      try {
        await invalidTodo.save();
      } catch (e) {
        error = e;
      }

      expect(error).toBeDefined();
      expect(error.errors.title).toBeDefined();
    });

    it('應該使用預設的 priority', async () => {
      const todo = new Todo({ title: '測試' });
      await todo.save();

      expect(todo.priority).toBe('medium');
    });

    it('應該拒絕無效的 priority 值', async () => {
      const todo = new Todo({
        title: '測試',
        priority: 'invalid'
      });

      let error;
      try {
        await todo.save();
      } catch (e) {
        error = e;
      }

      expect(error).toBeDefined();
      expect(error.errors.priority).toBeDefined();
    });
  });

  describe('時間戳記', () => {
    it('應該自動產生 createdAt 和 updatedAt', async () => {
      const todo = new Todo({ title: '測試' });
      const savedTodo = await todo.save();

      expect(savedTodo.createdAt).toBeDefined();
      expect(savedTodo.updatedAt).toBeDefined();
    });
  });
});
```

### 步驟 5：測試 Controller

```bash
claude "為 todoController 生成單元測試，使用 Mock：
1. getAllTodos - 測試分頁、篩選、排序
2. getTodoById - 測試成功和找不到的情況
3. createTodo - 測試成功和驗證錯誤
4. updateTodo - 測試成功和各種錯誤情況
5. deleteTodo - 測試成功和找不到的情況" --output tests/unit/controllers/todoController.test.js
```

## 整合測試

### 步驟 6：API 端點測試

```bash
claude "為 Todo API 生成整合測試，測試所有端點：
1. POST /api/todos - 建立待辦事項
2. GET /api/todos - 獲取所有待辦事項
3. GET /api/todos/:id - 獲取單一待辦事項
4. PUT /api/todos/:id - 更新待辦事項
5. DELETE /api/todos/:id - 刪除待辦事項
包含成功和失敗的情況" --output tests/integration/todoApi.test.js
```

**預期輸出範例：**
```javascript
const request = require('supertest');
const app = require('../../src/app');
const Todo = require('../../src/models/Todo');

describe('Todo API Integration Tests', () => {
  describe('POST /api/todos', () => {
    it('應該建立新的待辦事項', async () => {
      const newTodo = {
        title: '新的待辦事項',
        description: '測試描述',
        priority: 'high'
      };

      const response = await request(app)
        .post('/api/todos')
        .send(newTodo)
        .expect(201);

      expect(response.body.todo).toBeDefined();
      expect(response.body.todo.title).toBe(newTodo.title);
      expect(response.body.todo.completed).toBe(false);
    });

    it('應該拒絕沒有 title 的請求', async () => {
      const invalidTodo = {
        description: '沒有標題'
      };

      const response = await request(app)
        .post('/api/todos')
        .send(invalidTodo)
        .expect(400);

      expect(response.body.message).toContain('驗證錯誤');
    });
  });

  describe('GET /api/todos', () => {
    beforeEach(async () => {
      // 建立測試資料
      await Todo.create([
        { title: '待辦 1', priority: 'low' },
        { title: '待辦 2', priority: 'high', completed: true },
        { title: '待辦 3', priority: 'medium' }
      ]);
    });

    it('應該獲取所有待辦事項', async () => {
      const response = await request(app)
        .get('/api/todos')
        .expect(200);

      expect(response.body.todos).toHaveLength(3);
      expect(response.body.pagination).toBeDefined();
    });

    it('應該支援分頁', async () => {
      const response = await request(app)
        .get('/api/todos?page=1&limit=2')
        .expect(200);

      expect(response.body.todos).toHaveLength(2);
      expect(response.body.pagination.page).toBe(1);
      expect(response.body.pagination.limit).toBe(2);
    });

    it('應該支援篩選完成狀態', async () => {
      const response = await request(app)
        .get('/api/todos?completed=true')
        .expect(200);

      expect(response.body.todos).toHaveLength(1);
      expect(response.body.todos[0].completed).toBe(true);
    });

    it('應該支援優先級篩選', async () => {
      const response = await request(app)
        .get('/api/todos?priority=high')
        .expect(200);

      expect(response.body.todos).toHaveLength(1);
      expect(response.body.todos[0].priority).toBe('high');
    });
  });

  describe('GET /api/todos/:id', () => {
    let todoId;

    beforeEach(async () => {
      const todo = await Todo.create({ title: '測試待辦' });
      todoId = todo._id.toString();
    });

    it('應該獲取指定的待辦事項', async () => {
      const response = await request(app)
        .get(`/api/todos/${todoId}`)
        .expect(200);

      expect(response.body.title).toBe('測試待辦');
    });

    it('應該回傳 404 當待辦事項不存在', async () => {
      const fakeId = '507f1f77bcf86cd799439011';
      const response = await request(app)
        .get(`/api/todos/${fakeId}`)
        .expect(404);

      expect(response.body.message).toContain('找不到');
    });

    it('應該回傳 400 當 ID 格式無效', async () => {
      await request(app)
        .get('/api/todos/invalid-id')
        .expect(400);
    });
  });

  describe('PUT /api/todos/:id', () => {
    let todoId;

    beforeEach(async () => {
      const todo = await Todo.create({ title: '原始標題' });
      todoId = todo._id.toString();
    });

    it('應該更新待辦事項', async () => {
      const updates = {
        title: '更新後的標題',
        completed: true
      };

      const response = await request(app)
        .put(`/api/todos/${todoId}`)
        .send(updates)
        .expect(200);

      expect(response.body.todo.title).toBe('更新後的標題');
      expect(response.body.todo.completed).toBe(true);
    });

    it('應該拒絕無效的更新', async () => {
      const updates = {
        priority: 'invalid'
      };

      await request(app)
        .put(`/api/todos/${todoId}`)
        .send(updates)
        .expect(400);
    });
  });

  describe('DELETE /api/todos/:id', () => {
    let todoId;

    beforeEach(async () => {
      const todo = await Todo.create({ title: '要刪除的待辦' });
      todoId = todo._id.toString();
    });

    it('應該刪除待辦事項', async () => {
      await request(app)
        .delete(`/api/todos/${todoId}`)
        .expect(200);

      const deletedTodo = await Todo.findById(todoId);
      expect(deletedTodo).toBeNull();
    });

    it('應該回傳 404 當待辦事項不存在', async () => {
      const fakeId = '507f1f77bcf86cd799439011';
      await request(app)
        .delete(`/api/todos/${fakeId}`)
        .expect(404);
    });
  });
});
```

## 執行測試

### 步驟 7：運行所有測試

```bash
# 運行所有測試
npm test

# 以 watch 模式運行
npm run test:watch

# 生成覆蓋率報告
npm run test:coverage
```

### 步驟 8：檢查測試覆蓋率

```bash
# 查看覆蓋率報告
open coverage/lcov-report/index.html

# 或在終端機查看摘要
npm run test:coverage
```

**目標覆蓋率：**
- Statements: > 80%
- Branches: > 75%
- Functions: > 80%
- Lines: > 80%

## 測試優化

### 步驟 9：提取測試工具函數

```bash
claude "建立測試輔助函數，包含：
1. createTestTodo - 快速建立測試用 Todo
2. createMultipleTodos - 批次建立測試資料
3. authHeaders - 建立認證標頭（為未來擴充準備）
4. cleanDatabase - 清空資料庫" --output tests/helpers/testHelpers.js
```

### 步驟 10：添加測試資料工廠

```bash
claude "建立測試資料工廠，使用 faker 生成：
1. 隨機但合理的 Todo 資料
2. 不同狀態的 Todo 集合
3. 邊界值測試資料" --output tests/factories/todoFactory.js
```

## 進階測試

### 步驟 11：效能測試

```bash
claude "建立效能測試，測試：
1. 大量資料查詢效能
2. 並發請求處理
3. 記憶體使用" --output tests/performance/api.perf.test.js
```

### 步驟 12：安全測試

```bash
claude "建立安全測試，測試：
1. SQL/NoSQL 注入防護
2. XSS 防護
3. 輸入驗證
4. 錯誤訊息不洩漏敏感資訊" --output tests/security/security.test.js
```

## 持續整合

### 步驟 13：GitHub Actions 設定

```bash
claude "建立 GitHub Actions workflow，包含：
1. 安裝相依套件
2. 運行測試
3. 生成覆蓋率報告
4. 上傳到 Codecov
5. 失敗時通知" --output .github/workflows/test.yml
```

## 檢查清單

完成本節後，確認以下項目：

- [ ] 測試環境已設定（MongoDB Memory Server）
- [ ] 模型單元測試已完成
- [ ] Controller 單元測試已完成
- [ ] API 整合測試已完成
- [ ] 所有測試都通過
- [ ] 測試覆蓋率達到 80% 以上
- [ ] 測試輔助函數已建立
- [ ] CI/CD 已設定

## 常見問題

### Q: 測試太慢怎麼辦？
A: 使用 MongoDB Memory Server 加速，或使用 `--runInBand` 選項。

### Q: 測試資料庫如何隔離？
A: 使用 MongoDB Memory Server，每個測試套件使用獨立的記憶體資料庫。

### Q: 如何測試異步操作？
A: 使用 `async/await` 或返回 Promise。

### Q: Mock 還是真實資料庫？
A: 單元測試用 Mock，整合測試用真實資料庫（Memory Server）。

## 故障排除

### 測試超時

```javascript
// 增加測試超時時間
jest.setTimeout(10000);

// 或在 jest.config.js 中設定
module.exports = {
  testTimeout: 10000
};
```

### 資料庫連線錯誤

```bash
# 確認 MongoDB Memory Server 正確安裝
npm install --save-dev mongodb-memory-server

# 清除 Jest 快取
npx jest --clearCache
```

## 下一步

測試已完成！下一節我們將為 API 建立完整的文檔。

---

⏳ 內容持續補充中

## 導航

- **上一節**: [6.2 建立 Express API](./6.2-express-api.md)
- **下一節**: [6.4 建立文檔](./6.4-documentation.md)
- **返回章節目錄**: [第六章目錄](./README.md)
- **返回首頁**: [教材首頁](../../README.md)
