# 4.4 全端開發統一規範

## 📋 完整 CLAUDE.md 範例

```markdown
# 專案名稱: 全端 Web 應用

## 🎯 專案概觀
完整的全端 Web 應用,包含前端 React SPA 和後端 Node.js API。

## ⚙️ 整體技術棧

### 共用
- **程式語言**: TypeScript 5.0+
- **套件管理**: pnpm workspaces
- **版本控制**: Git + Conventional Commits
- **CI/CD**: GitHub Actions

### 前端
- **框架**: React 18 + Vite
- **狀態管理**: Zustand
- **樣式**: Tailwind CSS
- **路由**: React Router v6

### 後端
- **框架**: Express.js
- **資料庫**: PostgreSQL + Prisma
- **驗證**: JWT
- **API 文件**: Swagger

## 📏 通用編碼規範

### TypeScript 規範
- 啟用嚴格模式 (`strict: true`)
- 避免使用 `any`
- 所有函數明確回傳型別
- 共用型別放在 `packages/types`

### 命名慣例
- 變數/函數: camelCase
- 元件/類別: PascalCase
- 常數: UPPER_SNAKE_CASE
- 檔案: kebab-case

### 程式碼風格
- 2 空格縮排
- 單引號
- 每行最多 100 字元
- Prettier 格式化

### 註解規範
- 所有 public API 需要 JSDoc
- 複雜邏輯加入註解
- **註解使用繁體中文**

## 🏗️ Monorepo 結構
\`\`\`
project/
├── CLAUDE.md              # 專案通用規範
├── packages/
│   ├── types/            # 共用 TypeScript 型別
│   ├── utils/            # 共用工具函數
│   └── config/           # 共用配置
├── apps/
│   ├── web/              # 前端應用
│   │   └── CLAUDE.md    # 前端特定規範
│   └── api/              # 後端 API
│       └── CLAUDE.md    # 後端特定規範
├── package.json
└── pnpm-workspace.yaml
\`\`\`

## 🔗 前後端協作規範

### API 契約
- 使用 TypeScript 定義 API 型別
- 前後端共用型別定義
- API 回應格式統一

#### 共用型別範例
\`\`\`typescript
// packages/types/src/api.ts
export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
  };
}

export interface User {
  id: string;
  name: string;
  email: string;
  createdAt: string;
}

export interface CreateUserInput {
  name: string;
  email: string;
  password: string;
}

// 前端使用
import { ApiResponse, User } from '@project/types';
const response: ApiResponse<User> = await api.get('/users/me');

// 後端使用
import { ApiResponse, User, CreateUserInput } from '@project/types';
res.json<ApiResponse<User>>({
  success: true,
  data: user
});
\`\`\`

### 錯誤處理
- 統一的錯誤碼
- 前後端一致的錯誤處理
- 使用者友善的錯誤訊息

#### 錯誤碼定義
\`\`\`typescript
// packages/types/src/errors.ts
export enum ErrorCode {
  // 驗證錯誤 (400)
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  INVALID_INPUT = 'INVALID_INPUT',

  // 授權錯誤 (401, 403)
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  TOKEN_EXPIRED = 'TOKEN_EXPIRED',

  // 資源錯誤 (404)
  NOT_FOUND = 'NOT_FOUND',
  USER_NOT_FOUND = 'USER_NOT_FOUND',

  // 伺服器錯誤 (500)
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  DATABASE_ERROR = 'DATABASE_ERROR'
}

export const ERROR_MESSAGES: Record<ErrorCode, string> = {
  [ErrorCode.VALIDATION_ERROR]: '輸入資料格式錯誤',
  [ErrorCode.UNAUTHORIZED]: '請先登入',
  [ErrorCode.USER_NOT_FOUND]: '使用者不存在',
  // ...
};
\`\`\`

## 🚫 通用禁止事項
- ❌ 不使用 `any` 型別
- ❌ 不在程式碼中硬編碼敏感資訊
- ❌ 不直接修改 state (immutable)
- ❌ 不忽略錯誤
- ❌ 前後端不重複型別定義
  ✅ 使用共用套件

## 🔐 安全規範

### 驗證與授權
- JWT token 儲存在 httpOnly cookie
- Token 過期時間合理
- 實作 refresh token 機制
- CSRF 保護

### 資料驗證
- 前端驗證提升 UX
- 後端驗證確保安全
- 使用 Zod schema 共用驗證邏輯

#### 共用驗證範例
\`\`\`typescript
// packages/types/src/schemas.ts
import { z } from 'zod';

export const createUserSchema = z.object({
  name: z.string().min(2).max(50),
  email: z.string().email(),
  password: z.string().min(8).max(100)
});

export type CreateUserInput = z.infer<typeof createUserSchema>;

// 前端使用
import { createUserSchema } from '@project/types';

const handleSubmit = (data: unknown) => {
  const result = createUserSchema.safeParse(data);
  if (!result.success) {
    showErrors(result.error.errors);
    return;
  }
  await api.post('/users', result.data);
};

// 後端使用
import { createUserSchema } from '@project/types';

router.post('/users', (req, res) => {
  const input = createUserSchema.parse(req.body);
  // ...
});
\`\`\`

## 🧪 測試規範

### 前端測試
- 元件測試: Jest + React Testing Library
- E2E 測試: Playwright
- 覆蓋率 > 80%

### 後端測試
- API 測試: Jest + Supertest
- 單元測試: Jest
- 覆蓋率 > 80%

### 整合測試
- 測試前後端整合
- 使用測試資料庫
- 測試完整流程

## 📝 文件規範

### API 文件
- 使用 Swagger/OpenAPI
- 包含請求/回應範例
- 標註所有錯誤情況

### 程式碼文件
- JSDoc 註解
- README 說明架構
- 部署文件

## 🚀 部署規範

### 環境變數
\`\`\`bash
# 前端 (.env)
VITE_API_URL=http://localhost:3000/api
VITE_APP_NAME=MyApp

# 後端 (.env)
DATABASE_URL=postgresql://...
JWT_SECRET=...
PORT=3000
NODE_ENV=production
\`\`\`

### Docker 配置
\`\`\`yaml
# docker-compose.yml
version: '3.8'
services:
  web:
    build: ./apps/web
    ports:
      - "80:80"
    environment:
      - VITE_API_URL=http://api:3000

  api:
    build: ./apps/api
    ports:
      - "3000:3000"
    environment:
      - DATABASE_URL=postgresql://db:5432/myapp
    depends_on:
      - db

  db:
    image: postgres:15
    environment:
      - POSTGRES_DB=myapp
\`\`\`

## 📋 Git 工作流程

### 分支策略
- `main`: 生產環境
- `develop`: 開發環境
- `feature/*`: 功能開發
- `fix/*`: 錯誤修復

### Commit 規範
使用 Conventional Commits:
\`\`\`
feat(web): 新增使用者註冊頁面
fix(api): 修正 JWT 驗證錯誤
docs: 更新 API 文件
refactor(types): 重構共用型別定義
\`\`\`

### Pull Request 規範
- PR 標題遵循 Conventional Commits
- 包含變更說明
- 通過所有測試
- Code review 後合併

## ⚡ 效能優化

### 前端
- 程式碼分割 (React.lazy)
- 圖片懶載入
- API 快取 (React Query)
- Bundle 大小優化

### 後端
- 資料庫查詢優化
- Redis 快取
- API Rate Limiting
- 壓縮回應

## 🔍 監控與日誌

### 前端監控
- 錯誤追蹤 (Sentry)
- 效能監控 (Web Vitals)
- 使用者分析

### 後端監控
- API 回應時間
- 錯誤率
- 資料庫效能
- 系統資源使用
```

---

## 📁 子資料夾設定範例

### `apps/web/CLAUDE.md` (前端專屬)

```markdown
# 前端應用設定

> 繼承專案通用規範,額外遵循前端規則

## React 規範
- 僅使用 Function Components
- 使用 Hooks
- Props 定義 TypeScript interface

## 樣式規範
- 使用 Tailwind CSS
- 響應式設計
- 支援深色模式

## 狀態管理
- 使用 Zustand
- 全域狀態最小化
- 使用 Context for UI state
```

### `apps/api/CLAUDE.md` (後端專屬)

```markdown
# 後端 API 設定

> 繼承專案通用規範,額外遵循後端規則

## API 設計
- RESTful 設計
- 統一回應格式
- 適當的 HTTP 狀態碼

## 資料庫
- 使用 Prisma ORM
- 所有查詢錯誤處理
- 使用 transactions

## 安全性
- JWT 驗證
- Rate Limiting
- 輸入驗證 (Zod)
```

---

## 🎯 使用此設定

1. 根目錄 `CLAUDE.md` 設定通用規範
2. 子資料夾設定專屬規則
3. 使用共用套件 (`packages/`) 避免重複

## 導航

- **上一節**: [4.3 Python 資料分析](./4.3-python-data-analysis.md)
- **下一章**: [第五章: 進階技巧](../chapter5/README.md)
- **返回**: [教材首頁](../../README.md)
