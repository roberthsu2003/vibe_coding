# 4.2 Node.js 後端開發

## 📋 完整 CLAUDE.md 範例

```markdown
# 專案名稱: Node.js 後端 API 服務

## 🎯 專案概觀
提供 RESTful API 服務的 Node.js 後端應用,使用 Express 框架和 PostgreSQL 資料庫。

## ⚙️ 技術棧
- **程式語言**: TypeScript 5.0+
- **框架**: Express.js 4.x
- **資料庫**: PostgreSQL 15+
- **ORM**: Prisma 5.x
- **驗證**: JWT + Passport.js
- **驗證**: Zod
- **日誌**: Winston
- **測試**: Jest + Supertest
- **API 文件**: Swagger/OpenAPI

## 📏 編碼規範

### API 設計規範
- 使用 RESTful API 設計原則
- 正確使用 HTTP 方法 (GET/POST/PUT/PATCH/DELETE)
- 回應統一的 JSON 格式
- 使用適當的 HTTP 狀態碼

#### API 回應格式
\`\`\`typescript
// 成功回應
{
  "success": true,
  "data": { /* 資料 */ }
}

// 錯誤回應
{
  "success": false,
  "error": {
    "code": "USER_NOT_FOUND",
    "message": "使用者不存在"
  }
}
\`\`\`

### TypeScript 規範
- 啟用嚴格模式
- 所有函數明確定義回傳型別
- 使用 Zod 進行執行時驗證
- 使用 Prisma 生成的型別

### 錯誤處理
- 統一的錯誤處理中介軟體
- 自訂錯誤類別
- 不在錯誤訊息洩露敏感資訊
- 詳細記錄錯誤

#### 錯誤處理範例
\`\`\`typescript
// 自訂錯誤類別
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    public code: string,
    message: string
  ) {
    super(message);
  }
}

// 錯誤處理中介軟體
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
  if (err instanceof ApiError) {
    return res.status(err.statusCode).json({
      success: false,
      error: {
        code: err.code,
        message: err.message
      }
    });
  }

  logger.error('Unhandled error', { err, req: req.body });

  res.status(500).json({
    success: false,
    error: {
      code: 'INTERNAL_SERVER_ERROR',
      message: '伺服器錯誤'
    }
  });
});
\`\`\`

### 輸入驗證
- 所有輸入使用 Zod schema 驗證
- 驗證失敗返回 400 和詳細錯誤
- 型別安全的輸入處理

#### 驗證範例
\`\`\`typescript
import { z } from 'zod';

const createUserSchema = z.object({
  name: z.string().min(2).max(50),
  email: z.string().email(),
  age: z.number().int().min(18).max(120)
});

type CreateUserInput = z.infer<typeof createUserSchema>;

router.post('/users', async (req, res, next) => {
  try {
    const input = createUserSchema.parse(req.body);
    const user = await userService.createUser(input);
    res.json({ success: true, data: user });
  } catch (err) {
    if (err instanceof z.ZodError) {
      return res.status(400).json({
        success: false,
        error: {
          code: 'VALIDATION_ERROR',
          message: '輸入資料格式錯誤',
          details: err.errors
        }
      });
    }
    next(err);
  }
});
\`\`\`

## 🏗️ 專案結構
\`\`\`
src/
├── controllers/    # 控制器 (處理 HTTP 請求)
├── services/       # 業務邏輯層
├── models/         # 資料模型 (Prisma schema)
├── middlewares/    # 中介軟體
├── routes/         # 路由定義
├── utils/          # 工具函數
├── types/          # TypeScript 型別定義
├── config/         # 配置檔
├── validators/     # Zod schemas
└── server.ts       # 應用程式入口
\`\`\`

## 🔐 安全性要求

### 驗證與授權
- 所有受保護的端點需要 JWT 驗證
- 實作 RBAC (Role-Based Access Control)
- Token 過期時間設定合理 (1h access token, 7d refresh token)

### 資料保護
- 密碼使用 bcrypt 雜湊 (salt rounds >= 10)
- 敏感資料加密儲存
- 避免 SQL 注入 (使用 Prisma)
- 防範 XSS 攻擊
- 實作 Rate Limiting

#### 安全範例
\`\`\`typescript
import rateLimit from 'express-rate-limit';
import bcrypt from 'bcrypt';

// Rate Limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 分鐘
  max: 100 // 最多 100 次請求
});

app.use('/api/', limiter);

// 密碼雜湊
const hashPassword = async (password: string): Promise<string> => {
  return bcrypt.hash(password, 10);
};

const verifyPassword = async (
  password: string,
  hash: string
): Promise<boolean> => {
  return bcrypt.compare(password, hash);
};
\`\`\`

## 🗄️ 資料庫操作 (Prisma)

### 資料庫規範
- 所有查詢需要錯誤處理
- 避免 N+1 查詢問題
- 使用 transactions 處理關聯操作
- 實作軟刪除 (soft delete)

#### Prisma 範例
\`\`\`typescript
// ✅ 正確: 完整錯誤處理
const getUserWithPosts = async (userId: string) => {
  try {
    const user = await prisma.user.findUnique({
      where: { id: userId },
      include: {
        posts: {
          where: { published: true },
          orderBy: { createdAt: 'desc' }
        }
      }
    });

    if (!user) {
      throw new ApiError(404, 'USER_NOT_FOUND', '使用者不存在');
    }

    return user;
  } catch (error) {
    logger.error('Get user failed', { userId, error });
    throw error;
  }
};

// ✅ 使用 transaction
const createUserWithProfile = async (data: CreateUserInput) => {
  return prisma.$transaction(async (tx) => {
    const user = await tx.user.create({
      data: {
        email: data.email,
        name: data.name
      }
    });

    const profile = await tx.profile.create({
      data: {
        userId: user.id,
        bio: data.bio
      }
    });

    return { user, profile };
  });
};
\`\`\`

## 📝 日誌規範
- 使用 Winston 記錄日誌
- 不同環境使用不同日誌級別
- 記錄所有 API 請求/回應
- 記錄錯誤和異常
- 記錄安全相關事件

#### 日誌範例
\`\`\`typescript
import winston from 'winston';

export const logger = winston.createLogger({
  level: process.env.NODE_ENV === 'production' ? 'info' : 'debug',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});

// 請求日誌中介軟體
app.use((req, res, next) => {
  logger.info('API Request', {
    method: req.method,
    url: req.url,
    ip: req.ip,
    userId: req.user?.id
  });
  next();
});
\`\`\`

## 🚫 禁止事項
- ❌ 不直接在 controller 寫業務邏輯
  ✅ 使用 service 層

- ❌ 不在程式碼中硬編碼敏感資訊
  ✅ 使用環境變數

- ❌ 不使用 `SELECT *`
  ✅ 明確指定需要的欄位

- ❌ 不忽略錯誤
  ✅ 適當處理所有錯誤

## 🧪 測試要求
- API 端點測試覆蓋率 > 80%
- 使用 Jest + Supertest
- 測試成功和失敗情況
- 使用測試資料庫

#### 測試範例
\`\`\`typescript
import request from 'supertest';
import { app } from '../app';

describe('POST /api/users', () => {
  it('應該成功建立使用者', async () => {
    const response = await request(app)
      .post('/api/users')
      .send({
        name: 'John Doe',
        email: 'john@example.com',
        age: 25
      });

    expect(response.status).toBe(201);
    expect(response.body.success).toBe(true);
    expect(response.body.data).toHaveProperty('id');
  });

  it('應該在輸入無效時返回 400', async () => {
    const response = await request(app)
      .post('/api/users')
      .send({
        name: 'J',  // 太短
        email: 'invalid-email'  // 格式錯誤
      });

    expect(response.status).toBe(400);
    expect(response.body.success).toBe(false);
  });
});
\`\`\`

## ⚡ 效能優化
- 實作快取 (Redis)
- 資料庫查詢優化
- 使用連線池
- 實作分頁
- 壓縮回應 (gzip)

## 📖 API 文件
- 使用 Swagger/OpenAPI
- 文件包含範例
- 描述所有參數和回應
```

---

## 🎯 使用此設定

複製上方內容,儲存為 `CLAUDE.md`,並根據專案需求調整。

## 導航

- **上一節**: [4.1 React + TypeScript](./4.1-react-typescript.md)
- **下一節**: [4.3 Python 資料分析](./4.3-python-data-analysis.md)
- **返回**: [教材首頁](../../README.md)
